<?php
if (!defined('__GOOSE__')) exit();

$titleType = ($this->param['action'] == 'modify') ? '수정' : '만들기';
$nestName = ($repo['nest']['name']) ? '<em class="gs-brk-type">'.$repo['nest']['name'].'</em> ' : '';
$extPath = __GOOSE_ROOT__.'/vendor/';

$articleJSON = (isset($repo['article']['json'])) ? Util::arrayToJson($repo['article']['json'], true) : '';

$file = Module::load('file');
?>

<link rel="stylesheet" href="<?= __GOOSE_ROOT__.'/'.$this->skinPath.'css/markdown.css' ?>">
<link rel="stylesheet" href="<?= __GOOSE_ROOT__ ?>/vendor/rg-Uploader/dist/css/rg-uploader.min.css">
<link rel="stylesheet" href="<?= $extPath.'Parsedown/markdown.css' ?>" />

<section>
	<div class="gs-headding">
		<h1>
			<span><?=$nestName?>문서<?=$titleType?></span>
		</h1>
		<p><?=$this->set['description']?></p>
	</div>

	<form name="writeForm" action="<?=__GOOSE_ROOT__.'/article/'.$this->param['action'].'/'?>" method="post" enctype="multipart/form-data">
		<input type="hidden" name="app_srl" value="<?=$repo['nest']['app_srl']?>" />
		<input type="hidden" name="nest_srl" value="<?=$repo['nest']['srl']?>" />
		<input type="hidden" name="article_srl" value="<?=$article_srl?>" />
		<input type="hidden" name="skin" value="<?=$repo['nest']['json']['articleSkin']?>" />
		<input type="hidden" name="page" value="<?=$_GET['page']?>" />
		<input type="hidden" name="json" value="" />
		<input type="hidden" name="m" value="<?=$_GET['m']?>" />
		<input type="hidden" name="addQueue" />
		<input type="hidden" name="thumbnail_image" />

		<fieldset class="form-group">
			<?php
			if (count($repo['category']))
			{
			?>
				<dl class="gs-webz">
					<dt><label for="category">분류</label></dt>
					<dd>
						<select name="category_srl" id="category">
							<option value="">분류선택</option>
							<?php
							foreach($repo['category'] as $k=>$v)
							{
								$selected = ($repo['article']['category_srl']==$v['srl'] || $category_srl==$v['srl']) ? ' selected' : '';
								echo "<option value='$v[srl]'$selected>$v[name]</option>";
							}
							?>
						</select>
					</dd>
				</dl>
			<?php
			}
			?>

			<dl class="gs-webz">
				<dt><label for="title">제목</label></dt>
				<dd><input type="text" id="title" name="title" class="block" value="<?=$repo['article']['title']?>" /></dd>
			</dl>

			<dl>
				<dt><label for="content">내용</label></dt>
				<dd>
					<div class="mk-editor">
						<nav>
							<a href="#" data-control="edit" class="active">
								<i class="material-icons">code</i>
								<span>Edit</span>
							</a>
							<a href="#" data-control="preview">
								<i class="material-icons">remove_red_eye</i>
								<span>Preview</span>
							</a>
						</nav>
						<div class="body">
							<div class="show" data-target="edit">
								<textarea name="content" id="content" rows="20" class="block"><?=htmlspecialchars($repo['article']['content'])?></textarea>
								<p>
									* 존 그루버 마크다운 페이지 번역 : <a href="http://nolboo.github.io/blog/2013/09/07/john-gruber-markdown/" target="_blank">link</a><br/>
									* Markdown Extra : <a href="https://michelf.ca/projects/php-markdown/extra/" target="_blank">link</a>
								</p>
							</div>
							<div data-target="preview"></div>
						</div>
					</div>
				</dd>
			</dl>

			<dl>
				<dt><label>파일첨부</label></dt>
				<dd>
					<article class="rg-uploader" id="queuesManager">
						<div class="body" data-comp="queue">
							<div class="col queue" data-element="queue"><ul></ul></div>
						</div>
						<footer>
							<nav>
								<label class="add-file">
									<input type="file" data-element="addfiles" multiple>
									<i class="material-icons">add_circle_outline</i>
									<span>Add files</span>
								</label>
							</nav>
							<div class="size-info"></div>
						</footer>
					</article>
				</dd>
			</dl>
		</fieldset>

		<nav class="gs-btn-group right">
			<button type="submit" class="gs-button col-key"><?=$titleType?></button>
			<button type="button" class="gs-button" onclick="history.back(-1)">뒤로가기</button>
		</nav>
	</form>
</section>

<script src="<?= __GOOSE_ROOT__ ?>/vendor/rg-Uploader/dist/js/rg-uploader.pkgd.js"></script>
<script src="<?= __GOOSE_ROOT__ ?>/vendor/rg-Uploader/dist/js/plugin.pkgd.js"></script>
<script>
// set user data
var userData = {
	form : document.writeForm,
	root : '<?= __GOOSE_ROOT__ ?>',
	url : '<?= __GOOSE_URL__ ?>/',
	originalPath : '<?= $file->set['upPath_original'] ?>/',
	pushDatas : function(src) {
		try {
			return JSON.parse(src);
		} catch(e) {
			return null;
		}
	}('<?=require_once('attachFiles.php');?>'),
	articleData : function(src) {
		try {
			return JSON.parse(decodeURIComponent(src));
		} catch(e) {
			return {};
		}
	}('<?= $articleJSON ?>'),
	thumbnail : {},
	thumbnail_image : '',
	addQueue : []
};

// insert source to content form
var insertSourceToContentForm = function(items)
{
	// get cursor position
	var getCursorPosition = function($el)
	{
		var el = $el.get(0);
		var pos = 0;
		if ('selectionStart' in el)
		{
			pos = el.selectionStart;
		}
		else if ('selection' in document)
		{
			el.focus();
			var Sel = document.selection.createRange();
			var SelLength = document.selection.createRange().text.length;
			Sel.moveStart('character', -el.value.length);
			pos = Sel.text.length - SelLength;
		}
		return pos;
	};

	var str = '';
	for (var i=0; i<items.length; i++)
	{
		if (/^image/.test(items[i].type))
		{
			str += '![](' + items[i].src + ')\n';
		}
		else
		{
			str += '[' + items[i].name + '](' + items[i].src + ')\n';
		}
	}

	var pos = getCursorPosition($(userData.form.content));
	var val = userData.form.content.value;
	var newContent = val.substr(0, pos) + str + val.substr(pos);
	userData.form.content.value = newContent;
};

// get preview data
var getPreviewData = function(complete)
{
	var req = $.ajax({
		url : userData.root + '/script/run/markdown_preview/'
		,type : 'post'
		,data : {
			title : '...'
			,nest_srl : userData.form.nest_srl.value
			,content : userData.form.content.value
		}
	});
	req.done(function(str){
		complete(str);
	});
};

// check thumbnail image
var checkThumbnailImage = function()
{
	var files = uploader.queue.items.files;
	var inImage = false;

	// check thumbnail queue
	if (userData.form.article_srl.value && uploader.queue.$queue.children('.is-thumbnail').length)
	{
		return false;
	}

	// check image type in queues
	for (var i=0; i<files.length; i++)
	{
		if (/^image/i.test(files[i].type))
		{
			inImage = true;
			break;
		}
	}

	// check thumbnail_image value
	if (inImage && !userData.thumbnail_image)
	{
		alert('not make thumbnail image');
		return true;
	}
	else
	{
		return false;
	}
};


// init uploader
var uploader = new RGUploader($('#queuesManager'), {
	autoUpload : true,
	allowFileTypes : ['jpeg', 'png', 'gif'],
	limitSize : 3000000,
	limitSizeTotal : 10000000,
	uploadScript : userData.root + '/file/upload/',
	removeScript : userData.root + '/file/remove/',
	uploadParams : {
		table : 'file_tmp',
		upload_loc : userData.originalPath
	},
	srcPrefixName : userData.url,
	queue : {
		style : 'list',
		height : 150,
		limit : 10,
		datas : userData.pushDatas,
		buttons : [
			{
				name : 'open file',
				iconName : 'open_in_new',
				action : function(app, file) {
					window.open(file.fullSrc);
				}
			},
			{
				name : 'make thumbnail image',
				iconName : 'apps',
				className : 'btn-make-thumbnail',
				show : function(file) {
					return (file.type.split('/')[0] == 'image');
				},
				action : function(app, file) {
					if (!app.plugin.child.thumbnail) return false;
					var plugin = app.plugin.child.thumbnail;
					plugin.open(file);
				}
			},
			{
				name : 'insert editor',
				iconName : 'center_focus_strong',
				action : function(app, file) {
					insertSourceToContentForm([{
						src : file.fullSrc,
						name : file.name,
						type : file.type
					}]);
				}
			},
			{
				name : 'remove queue',
				iconName : 'close',
				action : function(app, file) {
					app.queue.removeQueue(file.id, false, true);
				}
			}
		]
	},
	plugin : [
		{ name : 'preview', obj : new RG_Preview() },
		{ name : 'sizeinfo', obj : new RG_Sizeinfo() },
		{ name : 'dnd', obj : new RG_DragAndDrop() },
		{
			name : 'thumbnail',
			obj : new RG_Thumbnail({
				width : 640,
				height : 480,
				mobileSize : 640,
				url_croppieCSS : userData.root + '/vendor/rg-Uploader/vendor/croppie/croppie.css',
				url_croppieJS : userData.root + '/vendor/rg-Uploader/vendor/croppie/croppie.min.js',
				output : {
					type : 'canvas',
					quality : .3,
					format : 'jpeg',
					// TODO : 다음 값들을 참고하여 type을 체크해서 썸네일 사이즈 정하기
//					thumbnail : {
//						type : '<?//=$repo['nest']['json']['thumnail']['type']?>//',
//						size : [
//							parseInt('<?//=$repo['nest']['json']['thumnail']['size'][0]?>//'),
//							parseInt('<?//=$repo['nest']['json']['thumnail']['size'][1]?>//')
//						]
//					}
					size : { width : 150, height : 150 }
				},
				doneCallback : function(res, app, file) {
					var classBtnMakeThumbnail = '.btn-make-thumbnail';

					// input thumbnail image source
					userData.thumbnail_image = res.src;

					// update on class name
					var $btns = app.queue.$queue.find(classBtnMakeThumbnail);
					$btns.removeClass('on is-thumbnail');
					app.queue.selectQueueElement(file.id)
						.addClass('is-thumbnail')
						.find(classBtnMakeThumbnail).addClass('on');

					// set thumbnail data
					var croppie = app.plugin.child.thumbnail.croppie.get();
					userData.thumbnail = {
						srl : file.srl,
						//url : file.src,
						points : croppie.points,
						zoom : croppie.zoom
					};
				}
			})
		}
	],
	uploadDataFilter : function(res) {
		return {
			state : res[0].state,
			response : {
				src : res[0].loc,
				srl : res[0].srl,
				name : res[0].name,
				table : 'file_tmp'
			}
		}
	},
	removeParamsFilter : function(res) {
		return {
			data : JSON.stringify([{ table : res.table, srl : res.srl }])
		};
	},
	removeDataFilter : function(res) {},
	uploadComplete : function(file) {
		userData.addQueue.push(file.srl);
	},
	init : function(app) {
		// add queue srls
		for(var i=0; i<userData.pushDatas.length; i++)
		{
			if (userData.pushDatas[i].table !== 'file_tmp') continue;
			userData.addQueue.push(userData.pushDatas[i].srl);
		}

		// set thumbnail queue
		if (userData.articleData.thumbnail)
		{
			//var key = app.queue.findItem(userData.articleData.thumbnail.srl);
			var $queue = app.queue.selectQueueElement(userData.articleData.thumbnail.srl);
			$queue
				.addClass('is-thumbnail')
				.find('.btn-make-thumbnail').addClass('on')
			;
		}
	}
});


// toggle edit/preview
var $mkEditor = $('div.mk-editor');
var $mkEditorButtons = $mkEditor.find('a[data-control]');
$mkEditorButtons.on('click', function(){

	var mode = $(this).attr('data-control');
	var $target = $mkEditor.find('[data-target=' + mode + ']');

	if (!$(this).hasClass('active'))
	{
		$mkEditorButtons.removeClass('active');
		$(this).addClass('active');
		$mkEditor.find('[data-target]').removeClass('show');
		$target.addClass('show');

		// load preview data
		if (mode == 'preview' && userData.form.content.value)
		{
			var result = getPreviewData(function(result){
				$target.html(result);
			});
		}
	}

	return false;
});

// init submit
$(userData.form).on('submit', function(){

	// set json
	var json = {};

	// check thumbnail image
	if (checkThumbnailImage())
	{
		return false;
	}

	// get article json
	json = userData.articleData;

	// set thumbnail data
	if (userData.thumbnail_image)
	{
		json.thumbnail = userData.thumbnail;
		userData.form.thumbnail_image.value = userData.thumbnail_image;
	}

	// set add queue srl
	userData.form.addQueue.value = userData.addQueue.toString();

	// json object to hidden string
	json = encodeURIComponent(JSON.stringify(json));
	userData.form.json.value = json;

	//return false;
	// TODO : 테스트 좀더해서 버그찾기
});
</script>
