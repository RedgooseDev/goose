jQuery(function(e){userData.articleData&&userData.articleData.thumbnail&&(userData.thumbnail=userData.articleData.thumbnail||{});var t=function(t){for(var a=(function(e){var t=e.get(0),a=0;if("selectionStart"in t)a=t.selectionStart;else if("selection"in document){t.focus();var i=document.selection.createRange(),r=document.selection.createRange().text.length;i.moveStart("character",-t.value.length),a=i.text.length-r}return a}),i="",r=0;r<t.length;r++)i+=/^image/.test(t[r].type)?"![]("+t[r].src+")\n":"["+t[r].name+"]("+t[r].src+")\n";var n=a(e(userData.form.content)),u=userData.form.content.value,s=u.substr(0,n)+i+u.substr(n);userData.form.content.value=s},a=function(){var t=e.Deferred(),a=e.ajax({url:userData.gooseRoot+"/script/run/markdown_preview/",type:"post",data:{title:"...",nest_srl:userData.form.nest_srl.value,content:userData.form.content.value}});return a.done(function(e){t.resolve(e)}),t.promise()},i=function(){var e=uploader.queue.items.files,t=!1;if(userData.form.article_srl.value&&uploader.queue.$queue.children(".is-thumbnail").length)return!1;for(var a=0;a<e.length;a++)if(/^image/i.test(e[a].type)){t=!0;break}return!(!t||userData.thumbnail_image)&&(alert("not make thumbnail image"),uploader.queue.$queue.find(".btn-make-thumbnail").eq(0).focus(),!0)},r=function(t,a){function i(e,t,a,i,r){var n={};switch(e){case"resize":i<r?(n.width=parseInt(i/r*a),n.height=parseInt(a)):(n.width=parseInt(t),n.height=parseInt(r/i*t));break;case"resizeWidth":n.width=parseInt(t),n.height=parseInt(r/i*t);break;case"resizeHeight":n.width=parseInt(i/r*a),n.height=parseInt(a);break;default:n.width=parseInt(t),n.height=parseInt(a)}return n}var r=e.Deferred(),n=new Image;return n.onload=function(e){var a=i(t.type,t.size.width,t.size.height,n.width,n.height);r.resolve(a)},n.src=userData.root+"/"+a.src,r.promise()};window.uploader=new RGUploader(e("#queuesManager"),{autoUpload:!0,allowFileTypes:["jpeg","png","gif"],limitSize:3e6,limitSizeTotal:1e7,uploadScript:userData.root+"/file/upload/",removeScript:userData.root+"/file/remove/",uploadParams:{table:"file_tmp",upload_loc:userData.originalPath},srcPrefixName:userData.url,queue:{style:"list",height:150,limit:10,datas:userData.pushDatas,buttons:[{name:"open file",iconName:"open_in_new",action:function(e,t){window.open(t.fullSrc)}},{name:"make thumbnail image",iconName:"apps",className:"btn-make-thumbnail",show:function(e){return"image"==e.type.split("/")[0]},action:function(e,t){if(!e.plugin.child.thumbnail)return!1;var a=e.plugin.child.thumbnail,i={};if(t.srl==userData.thumbnail.srl&&(i.points=userData.thumbnail.points,i.zoom=userData.thumbnail.zoom),userData.thumbnail.type&&"crop"==userData.thumbnail.type||!userData.thumbnail.type)a.open(t,i);else{var n=r(userData.thumbnailSet,t);n.done(function(e){a.assignOption({output:{size:{width:e.width,height:e.height}},croppie:{viewport:{width:e.width,height:e.height}}}),a.open(t,i)})}}},{name:"insert editor",iconName:"center_focus_strong",action:function(e,a){t([{src:a.fullSrc,name:a.name,type:a.type}])}},{name:"remove queue",iconName:"close",action:function(e,t){e.queue.removeQueue(t.srl,!1,!0)}}]},plugin:[{name:"preview",obj:new RG_Preview},{name:"sizeinfo",obj:new RG_Sizeinfo},{name:"dnd",obj:new RG_DragAndDrop},{name:"thumbnail",obj:new RG_Thumbnail({width:640,height:480,mobileSize:640,url_croppieCSS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.css",url_croppieJS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.min.js",output:{type:"canvas",quality:.85,format:"jpeg",size:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height}},croppie:{viewport:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height,type:"square"}},doneCallback:function(e,t,a){var i=".btn-make-thumbnail";userData.thumbnail_image=e.src,t.queue.$queue.children().removeClass("is-thumbnail"),t.queue.$queue.find(i).removeClass("on"),t.queue.selectQueueElement(a.id).find(i).addClass("on");var r=t.plugin.child.thumbnail.croppie.get(),n=t.plugin.child.thumbnail.options;userData.thumbnail.srl=a.srl,userData.thumbnail.points=r.points,userData.thumbnail.zoom=r.zoom,userData.thumbnail.size=n.output.size}})}],uploadDataFilter:function(e){return{state:e[0].state,response:{src:e[0].loc,srl:e[0].srl,name:e[0].name,table:"file_tmp"}}},removeParamsFilter:function(e){return{data:JSON.stringify([{table:e.table,srl:e.srl}])}},removeDataFilter:function(e){},uploadComplete:function(e){userData.addQueue.push(e.srl)},init:function(e){for(var t=0;t<userData.pushDatas.length;t++)"file_tmp"===userData.pushDatas[t].table&&userData.addQueue.push(userData.pushDatas[t].srl);if(userData.articleData.thumbnail){var a=e.queue.selectQueueElement(userData.articleData.thumbnail.srl);a.addClass("is-thumbnail").find(".btn-make-thumbnail").addClass("on")}}});var n=e("div.mk-editor"),u=n.find("a[data-control]");u.on("click",function(){var t=e(this).attr("data-control"),i=n.find("[data-target="+t+"]");if(!e(this).hasClass("active")&&(u.removeClass("active"),e(this).addClass("active"),n.find("[data-target]").removeClass("show"),i.addClass("show"),"preview"==t&&userData.form.content.value)){var r=a();r.done(function(e){i.html(e)})}return!1}),e(userData.form).on("submit",function(){if(i())return!1;var e=userData.articleData;userData.thumbnail_image&&(userData.form.thumbnail_image.value=userData.thumbnail_image),e.thumbnail=userData.thumbnail,userData.form.addQueue.value=userData.addQueue.toString(),e=encodeURIComponent(JSON.stringify(e)),userData.form.json.value=e})});