var insertSourceToContentForm=function(e){for(var a=(function(e){var a=e.get(0),t=0;if("selectionStart"in a)t=a.selectionStart;else if("selection"in document){a.focus();var r=document.selection.createRange(),n=document.selection.createRange().text.length;r.moveStart("character",-a.value.length),t=r.text.length-n}return t}),t="",r=0;r<e.length;r++)t+=/^image/.test(e[r].type)?"![]("+e[r].src+")\n":"["+e[r].name+"]("+e[r].src+")\n";var n=a($(userData.form.content)),i=userData.form.content.value,u=i.substr(0,n)+t+i.substr(n);userData.form.content.value=u},getPreviewData=function(e){var a=$.ajax({url:userData.root+"/script/run/markdown_preview/",type:"post",data:{title:"...",nest_srl:userData.form.nest_srl.value,content:userData.form.content.value}});a.done(function(a){e(a)})},checkThumbnailImage=function(){var e=uploader.queue.items.files,a=!1;if(userData.form.article_srl.value&&uploader.queue.$queue.children(".is-thumbnail").length)return!1;for(var t=0;t<e.length;t++)if(/^image/i.test(e[t].type)){a=!0;break}return!(!a||userData.thumbnail_image)&&(alert("not make thumbnail image"),!0)},uploader=new RGUploader($("#queuesManager"),{autoUpload:!0,allowFileTypes:["jpeg","png","gif"],limitSize:3e6,limitSizeTotal:1e7,uploadScript:userData.root+"/file/upload/",removeScript:userData.root+"/file/remove/",uploadParams:{table:"file_tmp",upload_loc:userData.originalPath},srcPrefixName:userData.url,queue:{style:"list",height:150,limit:10,datas:userData.pushDatas,buttons:[{name:"open file",iconName:"open_in_new",action:function(e,a){window.open(a.fullSrc)}},{name:"make thumbnail image",iconName:"apps",className:"btn-make-thumbnail",show:function(e){return"image"==e.type.split("/")[0]},action:function(e,a){if(!e.plugin.child.thumbnail)return!1;var t=e.plugin.child.thumbnail;t.open(a)}},{name:"insert editor",iconName:"center_focus_strong",action:function(e,a){insertSourceToContentForm([{src:a.fullSrc,name:a.name,type:a.type}])}},{name:"remove queue",iconName:"close",action:function(e,a){e.queue.removeQueue(a.id,!1,!0)}}]},plugin:[{name:"preview",obj:new RG_Preview},{name:"sizeinfo",obj:new RG_Sizeinfo},{name:"dnd",obj:new RG_DragAndDrop},{name:"thumbnail",obj:new RG_Thumbnail({width:640,height:480,mobileSize:640,url_croppieCSS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.css",url_croppieJS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.min.js",output:{type:"canvas",quality:.75,format:"jpeg",size:{width:userData.thumbnail.size.width,height:userData.thumbnail.size.height}},croppie:{viewport:{width:userData.thumbnail.size.width,height:userData.thumbnail.size.height,type:"square"}},doneCallback:function(e,a,t){var r=".btn-make-thumbnail";userData.thumbnail_image=e.src;var n=a.queue.$queue.find(r);n.removeClass("on is-thumbnail"),a.queue.selectQueueElement(t.id).addClass("is-thumbnail").find(r).addClass("on");var i=a.plugin.child.thumbnail.croppie.get();userData.thumbnail={srl:t.srl,points:i.points,zoom:i.zoom}}})}],uploadDataFilter:function(e){return{state:e[0].state,response:{src:e[0].loc,srl:e[0].srl,name:e[0].name,table:"file_tmp"}}},removeParamsFilter:function(e){return{data:JSON.stringify([{table:e.table,srl:e.srl}])}},removeDataFilter:function(e){},uploadComplete:function(e){userData.addQueue.push(e.srl)},init:function(e){for(var a=0;a<userData.pushDatas.length;a++)"file_tmp"===userData.pushDatas[a].table&&userData.addQueue.push(userData.pushDatas[a].srl);if(userData.articleData.thumbnail){var t=e.queue.selectQueueElement(userData.articleData.thumbnail.srl);t.addClass("is-thumbnail").find(".btn-make-thumbnail").addClass("on")}}}),$mkEditor=$("div.mk-editor"),$mkEditorButtons=$mkEditor.find("a[data-control]");$mkEditorButtons.on("click",function(){var e=$(this).attr("data-control"),a=$mkEditor.find("[data-target="+e+"]");if(!$(this).hasClass("active")&&($mkEditorButtons.removeClass("active"),$(this).addClass("active"),$mkEditor.find("[data-target]").removeClass("show"),a.addClass("show"),"preview"==e&&userData.form.content.value)){getPreviewData(function(e){a.html(e)})}return!1}),$(userData.form).on("submit",function(){if(checkThumbnailImage())return!1;var e=userData.articleData;userData.thumbnail_image&&(e.thumbnail=userData.thumbnail,userData.form.thumbnail_image.value=userData.thumbnail_image),userData.form.addQueue.value=userData.addQueue.toString(),e=encodeURIComponent(JSON.stringify(e)),userData.form.json.value=e});