var Thumnail=function(t,e){this.parent=t,this.maxImageSize=600,this.outputSize=null,this.ratio=null,this.windowName="thumnailWindow",this.settings=$.extend({},this.defaults,e),this.queue=null,this.$window=null,this.setData(t)};Thumnail.prototype.defaults={type:"crop",size:[200,200],quality:.7},Thumnail.prototype.setData=function(t){Thumnail.prototype.data={srl:t.settings.thumnail.srl,coords:t.settings.thumnail.coords?JSON.parse("["+t.settings.thumnail.coords+"]"):null,url:t.settings.thumnail.url,location:null}},Thumnail.prototype.template=function(){var t='<div id="'+this.windowName+'">\n';return t+='<div class="bg"></div>\n',t+='<div class="wrap">\n',t+="<figure></figure>\n",t+="<dl>\n",t+="<dt>출력사이즈</dt>\n",t+='<dd>가로:<em data-text="width">0</em>px, 세로:<em data-text="height">0</em>px</dd>\n',t+="</dl>\n",t+="<nav>\n",t+='<button type="button" data-action="center" class="gs-button col-key">중간으로</button>\n',t+='<button type="button" data-action="close" class="gs-button">닫기</button>\n',t+="</nav>\n",t+="</div>\n",t+="</div>",$(t)},Thumnail.prototype.getImageRatio=function(t,e){var i=this,a=[];switch(e){case"resize":a=[t.width(),t.height()];break;case"resizeWidth":a[0]=parseInt(i.settings.size[0]),a[1]=parseInt(t.height()/t.width()*i.settings.size[0]);break;case"resizeHeight":a[0]=parseInt(t.width()/t.height()*i.settings.size[1]),a[1]=parseInt(i.settings.size[1]);break;default:a=i.settings.size}return i.getRatio(a[0],a[1])},Thumnail.prototype.getOutputSize=function(t,e,i){var a,n;switch(e){case"resize":t.width()<t.height()?(a=parseInt(t.width()/t.height()*i[1]),n=parseInt(i[1])):(a=parseInt(i[0]),n=parseInt(t.height()/t.width()*i[0]));break;case"resizeWidth":a=parseInt(i[0]),n=parseInt(t.height()/t.width()*i[0]);break;case"resizeHeight":a=parseInt(t.width()/t.height()*i[1]),n=parseInt(i[1]);break;default:a=parseInt(i[0]),n=parseInt(i[1])}return[a,n]},Thumnail.prototype.getRatio=function(t,e){var i=parseInt(t)/parseInt(e);return i=Math.round(1e3*i)/1e3},Thumnail.prototype.resizePreview=function(t,e,i){t.width()>t.height()?(t.width(t.width()*i),t.width()>e&&t.width(e)):(t.height(t.height()*i),t.height()>e&&t.height(e))},Thumnail.prototype.getSelectCoords=function(t,e,i){return i?i:"crop"==e?t.width()<t.height()?[0,0,t.width(),0]:[0,0,0,t.height()]:[0,0,t.width(),t.height()]},Thumnail.prototype.onloadPreviewImage=function(t){var e=this,i=$(t);e.ratio=e.getImageRatio(i,e.settings.type),e.outputSize=e.getOutputSize(i,e.settings.type,e.settings.size),e.$window.find("[data-text=width]").text(e.outputSize[0]),e.$window.find("[data-text=height]").text(e.outputSize[1]),e.resizePreview(i,e.maxImageSize,.7),e.data.coords=e.getSelectCoords(i,e.settings.type,e.data.coords),i.Jcrop({bgOpacity:.4,setSelect:e.data.coords,aspectRatio:e.ratio,minSize:[50,50],onSelect:function(t){e.data.coords=[parseInt(t.x),parseInt(t.y)>0?parseInt(t.y):0,parseInt(t.x2),parseInt(t.y2),parseInt(t.w),parseInt(t.h)]}},function(){var t=this,a=e.$window.find("button[data-action=center]"),n=e.$window.find("button[data-action=close], div.bg"),o=e.$window.find("div.wrap");$("body").addClass("thumnailWindowMode"),o.css({marginLeft:0-.5*o.width()+"px"}),a.on("click",function(){var a,n,o=t.tellSelect();a=.5*i.width()-.5*o.w,n=.5*i.height()-.5*o.h,e.data.coords=[parseInt(a),parseInt(n)>0?parseInt(n):0,parseInt(a+o.w),parseInt(n+o.h),parseInt(o.w),parseInt(o.h)],t.animateTo(e.data.coords)}),n.on("click",function(){e.close()})})},Thumnail.prototype.open=function(t){var e=this;if(!e.$window){e.queue=t,e.$window=e.template(),t.srl!==e.data.srl&&(e.data.coords=null),e.data.srl=t.srl,e.data.location=t.location,e.data.url="";var i=e.$window.find("figure"),a=$('<img src="'+e.parent.settings.fileDir+e.data.location+'" />');i.append(a),$("body").append(e.$window),a.get(0).onload=function(){e.onloadPreviewImage(this)}}},Thumnail.prototype.close=function(){var t=this,e=t.parent.settings.thumnail.srl,i=t.parent.settings.thumnail.coords;(t.data.srl!==e||t.data.coords.toString()!==i)&&(t.data.image=t.getImageData(t.data.url),t.parent.queue.updateThumnailClass(t.queue.element)),$("body").removeClass("thumnailWindowMode"),t.$window.remove(),t.$window=null,t.queue=null},Thumnail.prototype.getImageData=function(t){var e=this,i=e.$window.find("figure > img"),a=document.createElement("canvas"),n=a.getContext("2d"),o=document.createElement("canvas"),s=o.getContext("2d"),r=e.data.coords,d=[i.get(0).naturalWidth,i.get(0).naturalHeight],h=[d[0]/i.width(),d[1]/i.height()];return a.width=2*e.outputSize[0],a.height=2*e.outputSize[1],n.drawImage(i.get(0),r[0]*h[0],r[1]*h[1],r[4]*h[0],r[5]*h[1],0,0,2*e.outputSize[0],2*e.outputSize[1]),o.width=e.outputSize[0],o.height=e.outputSize[1],s.fillStyle="#ffffff",s.fillRect(0,0,e.outputSize[0],e.outputSize[1]),s.drawImage(a,0,0,.5*a.width,.5*a.height),o.toDataURL("image/jpeg",e.settings.quality)};