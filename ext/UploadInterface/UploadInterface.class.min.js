var UploadInterface=function(e,t){var n=this;this.$el=$(e),this.el=e,this.settings=$.extend({},this.defaults,t),this.key=!1,this.queue=null,this.$drop=null,this.readyItem=[],this.getCursorPosition=function(e){var t=e.get(0),n=0;if("selectionStart"in t)n=t.selectionStart;else if("selection"in document){t.focus();var i=document.selection.createRange(),a=document.selection.createRange().text.length;i.moveStart("character",-t.value.length),n=i.text.length-a}return n},this.bytesToSize=function(e){var t=["Bytes","KB","MB","GB","TB"];if(0==e)return"0Byte";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,n),2)+""+t[n]},this.resetInput=function(){n.$el.replaceWith(n.$el=n.$el.clone(!0))},n.settings.$manager&&(n.thumnail=n.initThumnail(),n.queue=new FilesQueue(n,n.$queue,{}),n.$drop=n.$queue.children("ul"),n.settings.$manager.append(n.$queue).append(n.$controller),n.controllerButton(),n.events(),n.ready=!0)};UploadInterface.prototype.defaults={uploadAction:null,removeAction:null,filesizeLimit:5e6},UploadInterface.prototype.$queue=$('<div class="filesQueue"><figure class="thumnail"></figure><ul></ul></div>'),UploadInterface.prototype.$controller=$('<nav id="queueController"></nav>'),UploadInterface.prototype.controllerButton=function(){var e=this,t="";t+='<button type="button" data-action="insertContents" class="gs-button size-small col-key">본문삽입</button>',t+='<button type="button" data-action="selectAll" class="gs-button size-small">모두선택</button>',t+='<button type="button" data-action="deleteSelect" class="gs-button size-small">선택삭제</button>',t+='<button type="button" data-action="deleteAll" class="gs-button size-small">모두삭제</button>',this.$controller.append($(t)).children("button").on("click",function(){switch($(this).attr("data-action")){case"insertContents":e.insertContent();break;case"selectAll":e.selectAllQueue();break;case"deleteSelect":e.deleteQueue();break;case"deleteAll":e.deleteAllQueue()}})},UploadInterface.prototype.events=function(){var e=this;e.settings.auto&&e.$el.on("change",function(){e.upload()}),$(window).on("keydown",function(t){(91==t.which||17==t.which)&&(e.key=!0)}),$(window).on("keyup",function(){e.key=!1}),e.$drop&&(e.$drop.on("dragover",!1),e.$drop.on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),$(this).addClass("drag")}),e.$drop.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),$(this).removeClass("drag")}),e.$drop.on("drop",function(t){var n=t.originalEvent.dataTransfer;n&&n.files.length&&(t.preventDefault(),t.stopPropagation(),$(this).removeClass("drag"),e.upload(n.files))}))},UploadInterface.prototype.fileUpload=function(e){new FileUpload(this,this.settings.uploadAction,this.queue.index[e.key],e.file,userData.originalPath)},UploadInterface.prototype.upload=function(e){var t=this;if(t.$queue){var n=e?e:t.$el.get(0).files,i=Object.keys(t.queue.index).length+n.length,a=null;if(t.settings.limit&&i>t.settings.limit)a="파일은 총 "+t.settings.limit+"개까지 업로드할 수 있습니다.";else{for(var l=0;l<n.length;l++)n[l].size<this.settings.filesizeLimit?t.readyItem.push({key:t.queue.createQueue(n[l]),file:n[l]}):a="허용용량을 초과하는 파일이 있습니다.\n허용용량은 "+t.bytesToSize(this.settings.filesizeLimit)+"까지입니다.";t.readyItem.length&&t.fileUpload(t.readyItem[0])}}else a="not install queue manager";return a?(alert(a),!1):void 0},UploadInterface.prototype.uploadProgress=function(e,t,n){var i=parseInt(e/t*100);n.state="loading",n.element.find("span.size").text(i+"%"),n.element.find("span.state").text("Loading"),n.element.find("div.progress span").width(i+"%")},UploadInterface.prototype.uploadComplete=function(e,t){var n=this;try{var i=JSON.parse(e)[0];if("error"==i.state)return log(i),i.message&&alert(i.message),t.element.remove(),!1;t.state="complete",t.srl=i.srl,t.location=i.loc,t.type="session",t.filename=i.name,t.filetype=i.type,t.element.find("span.name").text(t.filename),t.element.find("span.size").text(n.bytesToSize(t.filesize)),t.element.find("span.state").text(t.state),"complete"==t.state&&t.element.find("div.progress").delay(200).fadeOut(400),n.resetInput(),n.refreshAddQueue(),n.readyItem.splice(0,1),n.readyItem.length&&n.fileUpload(n.readyItem[0])}catch(a){log(e),alert("ERROR UPLOAD"),t.element.remove()}},UploadInterface.prototype.pushQueue=function(e){for(var t=this,n=0;n<e.length;n++){var i=t.queue.createQueue({name:e[n].filename,size:e[n].filesize,type:e[n].filetype,loc:e[n].location,srl:e[n].srl,type2:e[n].type,state:e[n].state});t.thumnail.data.srl==e[n].srl&&t.queue.index[i].element.addClass("thumnail")}e.length&&"session"==e[0].type&&t.refreshAddQueue()},UploadInterface.prototype.insertContent=function(e){var t=this,n=e?new Array(t.queue.index[e.attr("key")]):t.queue.getItems();if(t.settings.insertFunc){for(var i=[],a=0;a<n.length;a++)i.push({url:t.settings.fileDir+"/"+n[a].location,type:n[a].filetype,name:n[a].filename});t.settings.insertFunc(i)}else if(t.settings.$insertTarget){for(var l=t.settings.$insertTarget,o=t.getCursorPosition(l),r=l.val(),s="",a=0;a<n.length;a++)s+=/^image/.test(n[a].filetype)?'<img src="'+t.settings.fileDir+"/"+n[a].location+'" alt="" />\n':'<a href="'+t.settings.fileDir+"/"+n[a].location+'">'+n[a].filename+"</a>\n";l.val(r.substr(0,o)+s+r.substr(o))}},UploadInterface.prototype.uploadError=function(e,t){log(e)},UploadInterface.prototype.selectAllQueue=function(){this.queue.selectAllQueue()},UploadInterface.prototype.deleteQueue=function(){var e=this;if(confirm("선택한 파일을 삭제하시겠습니까?")){var t=e.$queue.find("> ul > li.on");t.length?e.queue.removeQueue(t):alert("선택한 파일이 없습니다.")}},UploadInterface.prototype.deleteAllQueue=function(){var e=this;if(confirm("모두 삭제하시겠습니까?")){var t=e.$queue.find("> ul >li");t.length?(e.queue.removeQueue(t),e.queue.clearPreview()):alert("업로드 되어있는 파일이 없습니다.")}},UploadInterface.prototype.refreshAddQueue=function(){var e=this,t=$.map(e.queue.index,function(e,t){return"edit"!==e.type?e.srl:void 0}).join(",");e.settings.form.addQueue.value=t},UploadInterface.prototype.thumnailImageCheck=function(){var e=this,t=e.queue.$index.children();if(t.filter(".thumnail").length)return!1;var n=!1;return t.each(function(){var t=e.queue.getIndexItem($(this).attr("key"));return/^image/i.test(t.filetype)?(n=!0,!1):void 0}),n&&!e.settings.form.thumnail_image.value?(alert("썸네일 이미지를 만들지 않았습니다."),e.queue.$index.find("[data-action=thumnail]").eq(0).focus(),!0):!1},UploadInterface.prototype.initThumnail=function(){var e=this;return new Thumnail(e,{type:e.settings.thumnail.type,size:e.settings.thumnail.size.split("*"),quality:.8,data:{srl:e.settings.thumnail.srl,coords:e.settings.thumnail.coords,url:e.settings.thumnail.url}})};