function log(o){console.log(o)}Object.size=function(obj){var size=0,key;for(key in obj){if(obj.hasOwnProperty(key))size++}return size};var JSONEditor=function($wrap,usePreview){var self=this;self.$wrap=$wrap;self.$index=null;self.$preview=null;var util=new Util;var context=new Context(this,this.contextTree);function Util(){this.removeBR=function(element){element.find("br").replaceWith(" ")};this.stringLimiter=function(element,limit){var str=element.text();if(str.length>limit){element.text(str.substring(0,limit))}};this.removeSpace=function(element){element.text(element.text().replace(/\s+/g,""))}}function Context(getParent,tree){var self=this;var parent=getParent;self.$el=null;self.active=null;var template=function(obj){function node(obj){var str="<ul>";for(var o in obj){str+='<li role="'+obj[o].role+'">';if(obj[o].roles){str+="<div>";str+=node(obj[o].roles);str+="</div>"}str+='<button type="button">'+obj[o].role+"</button>";str+="</li>"}str+="</ul>";return str}var str='<nav class="context">';str+=node(obj);str+="</nav>";return $(str)};var createContext=function(){self.$el=template(tree);parent.$wrap.append(self.$el)};var contextEvent=function($nav){$nav.find("li").on("click",function(e){e.stopPropagation()});$nav.find("li[role=Type] li").on("click",function(){parent.typeItem(self.active,$(this).attr("role"));context.off()});$nav.find("li[role=Insert] li").on("click",function(){parent.insertItem(self.active,$(this).attr("role"),null);context.off()});$nav.find("li[role=Duplicate]").on("click",function(){parent.duplicateItem(self.active);context.off()});$nav.find("li[role=Remove]").on("click",function(){parent.removeItem(self.active);context.off()})};this.on=function($item,button){self.active=$item;self.$el.attr("type",$item.attr("type")).css({left:button.position().left+button.outerWidth(),top:button.position().top-3});if($item.attr("loc")=="root"){self.$el.attr("loc",$item.attr("loc"))}else{self.$el.removeAttr("loc")}$("html").on("click",function(){self.off()})};this.off=function(){self.active=null;self.$el.removeAttr("type");$("html").off("click")};createContext();contextEvent(self.$el)}var init=function(){self.$index=$('<div class="index" />');self.$index.append(createRoot());self.$wrap.prepend(self.$index);self.$preview=$('<pre class="preview" />');self.$wrap.append(self.$preview);self.$wrap.addClass("preview");updatePreview()};var template=function(type){var str='<li type="'+type+'" class="on">\n';str+="<dl>";str+="<dt>";str+='<button type="button" role="move">move</button>';str+='<button type="button" role="control">control</button>';str+='<em class="no">0</em>';str+='<button type="button" role="toggle">toggle</button>';str+='<strong contenteditable="true" spellcheck="false" data-ph="'+type+'"></strong>';str+='<span class="type"></span>';str+='<em class="count">0</em>';str+="</dt>";str+="<dd>";str+='<span contenteditable="true" spellcheck="false"></span>';str+="</dd>";str+="</dl>";str+="<ul></ul>";str+="</li>";return $(str)};var selectButtons=function($li){return $li.children("dl").children("dt").children("button")};var updateCount=function($li){var itemCount=$li.find("> ul > li").length;$li.find("> dl em.count").text(itemCount)};var updateNumber=function($items){$items.each(function(k){$(this).find("> dl > dt > em.no").text(k)})};var inputCheckEvent=function($item){var $strong=$item.find("> dl > dt > strong");var $inputs=$item.find("> dl > dt > strong, > dl > dd > span");$strong.on("blur",function(){util.removeBR($(this));util.removeSpace($(this));util.stringLimiter($(this),20)});$inputs.on("blur",function(){updatePreview()})};var buttonsEvent=function($buttons){var $node=$buttons.closest("li");$buttons.filter("[role=control]").on("click",function(e){e.stopPropagation();context.off($node);context.on($node,$(this))});$buttons.filter("[role=toggle]").on("click",function(e){$node.toggleClass("on")})};var dragEvent=function($item){var adjustment,beforeItem;$item.children("ul").sortable({itemSelector:"li",handle:"button[role=move]",group:"index",pullPlaceholder:true,onDrop:function(item,targetContainer,_super){_super(item);updateCount(beforeItem.parent());updateCount(targetContainer.el.parent());updateNumber(beforeItem.children());updateNumber(targetContainer.el.children());updatePreview();beforeItem=adjustment=null},onDragStart:function($el,container,_super){var offset=$el.offset(),pointer=container.rootGroup.pointer;adjustment={left:pointer.left-offset.left,top:pointer.top-offset.top};beforeItem=container.el;_super($el,container)},onDrag:function($el,position){$el.css({left:position.left-adjustment.left,top:position.top-adjustment.top})},isValidTarget:function($el,container){return container.el.parent().attr("type")=="String"?false:true}})};var createRoot=function(){var $ul=$("<ul/>");var $li=template("Object");$li.attr("loc","root");$li.find("[contenteditable]").attr("contenteditable","false");$li.find("[role=move]").remove();$ul.append($li);buttonsEvent(selectButtons($li));dragEvent($li);return $ul};var updatePreview=function(){self.$preview.text(self.exportJSON(5))};this.insertItem=function($active,type,data,complete){var $ul=$active.children("ul");var $item=template(type);$item.find("em.no").text($ul.children("li").length);if(data){$item.find("dt strong").text(data.key);$item.find("dd span").text(data.value)}buttonsEvent(selectButtons($item));inputCheckEvent($item);$active.addClass("on").children("ul").append($item);updateCount($active);if(complete){complete($item)}};this.typeItem=function($active,type){$active.attr("type",type);$active.find("> dl > dt > strong").attr("data-ph",type);updatePreview()};this.duplicateItem=function($target){var $copy=$target.clone().insertAfter($target).find("li").andSelf();$copy.each(function(){buttonsEvent(selectButtons($(this)));inputCheckEvent($(this))});updateCount($target.parent().parent());updateNumber($target.parent().children());updatePreview()};this.removeItem=function($target){var $parentItem=$target.parent().parent();$target.remove();updateCount($parentItem);updatePreview()};this.importJSON=function(data){function items(getData,$item){$.each(getData,function(index,value){var data={key:index,value:value},type=null;if(typeof value==="string"){type="String"}else if(typeof value==="object"){type=Array.isArray(value)?"Array":"Object"}self.insertItem($item,type,data,function($item){if(type!=="String"&&Object.size(value)>0){items(value,$item)}})})}items(data,self.$index.find("[loc=root]"));updatePreview()};this.exportJSON=function(space){function items($li,obj){var $lis=$li.children("ul").children("li");if($lis.length){$lis.each(function(){var $this=$(this),key=$this.find("> dl > dt > strong").text(),value=$this.find("> dl > dd > span").text();switch($(this).attr("type")){case"String":if($li.attr("type")=="Array"){obj.push(value)}else{obj[key]=value}break;case"Array":if($li.attr("type")=="Array"){obj.push(items($this,new Array))}else{obj[key]=items($this,new Array)}break;case"Object":if($li.attr("type")=="Array"){obj.push(items($this,new Object))}else{obj[key]=items($this,new Object)}break}})}return obj}var $root=self.$index.find("[loc=root]");var json=items($root,$root.attr("type")=="Array"?new Array:new Object);return JSON.stringify(json,null,space?space:0)};init()};JSONEditor.prototype.contextTree=[{role:"Type",roles:[{role:"Object"},{role:"Array"},{role:"String"}]},{role:"Insert",roles:[{role:"Object"},{role:"Array"},{role:"String"}]},{role:"Duplicate"},{role:"Remove"}];