jQuery(function(e){userData.articleData&&userData.articleData.thumbnail&&(userData.thumbnail=userData.articleData.thumbnail||{});var a=function(a){for(var t=(function(e){var a=e.get(0),t=0;if("selectionStart"in a)t=a.selectionStart;else if("selection"in document){a.focus();var r=document.selection.createRange(),i=document.selection.createRange().text.length;r.moveStart("character",-a.value.length),t=r.text.length-i}return t}),r="",i=0;i<a.length;i++)r+=/^image/.test(a[i].type)?"![]("+a[i].src+")\n":"["+a[i].name+"]("+a[i].src+")\n";var n=t(e(userData.form.content)),u=userData.form.content.value,s=u.substr(0,n)+r+u.substr(n);userData.form.content.value=s},t=function(){var a=e.Deferred(),t=e.ajax({url:userData.gooseRoot+"/script/run/markdown_preview/",type:"post",data:{title:"...",nest_srl:userData.form.nest_srl.value,content:userData.form.content.value}});return t.done(function(e){a.resolve(e)}),a.promise()},r=function(){var e=uploader.queue.items.files,a=!1;if(userData.form.article_srl.value&&uploader.queue.$queue.children(".is-thumbnail").length)return!1;for(var t=0;t<e.length;t++)if(/^image/i.test(e[t].type)){a=!0;break}return!(!a||userData.thumbnail_image)&&(alert("not make thumbnail image"),uploader.queue.$queue.find(".btn-make-thumbnail").eq(0).focus(),!0)},i=function(a,t){function r(e,a,t,r,i){var n={};switch(e){case"resize":r<i?(n.width=parseInt(r/i*t),n.height=parseInt(t)):(n.width=parseInt(a),n.height=parseInt(i/r*a));break;case"resizeWidth":n.width=parseInt(a),n.height=parseInt(i/r*a);break;case"resizeHeight":n.width=parseInt(r/i*t),n.height=parseInt(t);break;default:n.width=parseInt(a),n.height=parseInt(t)}return n}var i=e.Deferred(),n=new Image;return n.onload=function(e){var t=r(a.type,a.size.width,a.size.height,n.width,n.height);i.resolve(t)},n.src=userData.root+"/"+t.src,i.promise()};window.uploader=new RGUploader(e("#queuesManager"),{autoUpload:!0,allowFileTypes:["jpeg","png","gif"],limitSize:3e6,limitSizeTotal:1e7,uploadScript:userData.root+"/file/upload/",removeScript:userData.root+"/file/remove/",uploadParams:{ready:1},srcPrefixName:userData.url,queue:{style:"list",height:150,limit:10,datas:userData.pushDatas,buttons:[{name:"open file",iconName:"open_in_new",action:function(e,a){window.open(a.fullSrc)}},{name:"make thumbnail image",iconName:"apps",className:"btn-make-thumbnail",show:function(e){return"image"==e.type.split("/")[0]},action:function(e,a){if(!e.plugin.child.thumbnail)return!1;var t=e.plugin.child.thumbnail,r={};if(a.srl==userData.thumbnail.srl&&(r.points=userData.thumbnail.points,r.zoom=userData.thumbnail.zoom),userData.thumbnail.type&&"crop"==userData.thumbnail.type||!userData.thumbnail.type)t.open(a,r);else{var n=i(userData.thumbnailSet,a);n.done(function(e){t.assignOption({output:{size:{width:e.width,height:e.height}},croppie:{viewport:{width:e.width,height:e.height}}}),t.open(a,r)})}}},{name:"insert editor",iconName:"center_focus_strong",action:function(e,t){a([{src:t.fullSrc,name:t.name,type:t.type}])}},{name:"remove queue",iconName:"close",action:function(e,a){e.queue.removeQueue(a.id,!1,!0)}}]},plugin:[{name:"preview",obj:new RG_Preview},{name:"sizeinfo",obj:new RG_Sizeinfo},{name:"dnd",obj:new RG_DragAndDrop},{name:"thumbnail",obj:new RG_Thumbnail({width:640,height:480,mobileSize:640,url_croppieCSS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.css",url_croppieJS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.min.js",output:{type:"canvas",quality:.85,format:"jpeg",size:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height}},croppie:{viewport:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height,type:"square"}},doneCallback:function(e,a,t){var r=".btn-make-thumbnail";userData.thumbnail_image=e.src,a.queue.$queue.children().removeClass("is-thumbnail"),a.queue.$queue.find(r).removeClass("on"),a.queue.selectQueueElement(t.id).find(r).addClass("on");var i=a.plugin.child.thumbnail.croppie.get(),n=a.plugin.child.thumbnail.options;userData.thumbnail.srl=t.srl,userData.thumbnail.points=i.points,userData.thumbnail.zoom=i.zoom,userData.thumbnail.size=n.output.size}})}],uploadDataFilter:function(e){return{state:e[0].state,response:{src:e[0].loc,srl:e[0].srl,name:e[0].name,ready:e[0].ready}}},removeParamsFilter:function(e){return{data:JSON.stringify([{srl:e.srl}])}},removeDataFilter:function(e){},uploadComplete:function(e){userData.addQueue.push(e.srl)},init:function(e){for(var a=0;a<userData.pushDatas.length;a++)"file_tmp"===userData.pushDatas[a].table&&userData.addQueue.push(userData.pushDatas[a].srl);if(userData.articleData.thumbnail){var t=e.queue.selectQueueElement(userData.articleData.thumbnail.srl);t.addClass("is-thumbnail").find(".btn-make-thumbnail").addClass("on")}}});var n=e("div.mk-editor"),u=n.find("a[data-control]");u.on("click",function(){var a=e(this).attr("data-control"),r=n.find("[data-target="+a+"]");if(!e(this).hasClass("active")&&(u.removeClass("active"),e(this).addClass("active"),n.find("[data-target]").removeClass("show"),r.addClass("show"),"preview"==a&&userData.form.content.value)){var i=t();i.done(function(e){r.html(e)})}return!1}),e(userData.form).on("submit",function(){if(r())return!1;var e=userData.articleData;userData.thumbnail_image&&(userData.form.thumbnail_image.value=userData.thumbnail_image),e.thumbnail=userData.thumbnail,userData.form.addQueue.value=userData.addQueue.toString(),e=encodeURIComponent(JSON.stringify(e)),userData.form.json.value=e})});