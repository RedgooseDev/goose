jQuery(function(e){userData.articleData&&userData.articleData.thumbnail&&(userData.thumbnail=userData.articleData.thumbnail||{});var t=function(t){for(var a="",i=0;i<t.length;i++)/^image/.test(t[i].type)?a+="![]("+t[i].src+")\n":a+="["+t[i].name+"]("+t[i].src+")\n";var n=function(e){var t=e.get(0),a=0;if("selectionStart"in t)a=t.selectionStart;else if("selection"in document){t.focus();var i=document.selection.createRange(),n=document.selection.createRange().text.length;i.moveStart("character",-t.value.length),a=i.text.length-n}return a}(e(userData.form.content)),r=userData.form.content.value;userData.form.content.value=r.substr(0,n)+a+r.substr(n)},a=function(){var t=e.Deferred();return e.ajax({url:userData.previewScriptPath,type:"post",data:{content:userData.form.content.value}}).done(function(e){t.resolve(e)}),t.promise()},i=function(){var e=uploader.queue.items.files,t=!1;if(userData.form.article_srl.value&&uploader.queue.$queue.children(".is-thumbnail").length)return!1;for(var a=0;a<e.length;a++)if(/^image/i.test(e[a].type)){t=!0;break}return!(!t||userData.thumbnail_image)&&(alert("not make thumbnail image"),uploader.queue.$queue.find(".btn-make-thumbnail").eq(0).focus(),!0)},n=function(t,a){function i(e,t,a,i,n){var r={};switch(e){case"resize":i<n?(r.width=parseInt(i/n*a),r.height=parseInt(a)):(r.width=parseInt(t),r.height=parseInt(n/i*t));break;case"resizeWidth":r.width=parseInt(t),r.height=parseInt(n/i*t);break;case"resizeHeight":r.width=parseInt(i/n*a),r.height=parseInt(a);break;default:r.width=parseInt(t),r.height=parseInt(a)}return r}var n=e.Deferred(),r=new Image;return r.onload=function(e){var a=i(t.type,t.size.width,t.size.height,r.width,r.height);n.resolve(a)},r.src=userData.root+"/"+a.src,n.promise()};window.uploader=new RGUploader(e("#queuesManager"),{autoUpload:!0,allowFileTypes:["jpeg","png","gif","zip","pdf"],limitSize:userData.uploader.limitSize,limitSizeTotal:userData.uploader.limitSizeTotal,uploadScript:userData.root+"/File/upload/",removeScript:userData.root+"/File/remove/",srcPrefixName:userData.url,queue:{style:"list",height:150,limit:userData.uploader.queueLimitCount,datas:userData.pushDatas,buttons:[{name:"open file",iconName:"open_in_new",action:function(e,t){window.open(t.fullSrc)}},{name:"make thumbnail image",iconName:"apps",className:"btn-make-thumbnail",show:function(e){return"image"===e.type.split("/")[0]},action:function(e,t){if(!e.plugin.child.thumbnail)return!1;var a=e.plugin.child.thumbnail,i={};t.srl===userData.thumbnail.srl&&(i.points=userData.thumbnail.points,i.zoom=userData.thumbnail.zoom),userData.thumbnailSet.type&&"crop"===userData.thumbnailSet.type||!userData.thumbnailSet.type?a.open(t,i):n(userData.thumbnailSet,t).done(function(e){a.assignOption({output:{size:{width:e.width,height:e.height}},croppie:{viewport:{width:e.width,height:e.height}}}),a.open(t,i)})}},{name:"insert editor",iconName:"center_focus_strong",action:function(e,a){t([{src:a.fullSrc,name:a.name,type:a.type}])}},{name:"remove queue",iconName:"close",action:function(e,t){e.queue.removeQueue(t.id,!1,!0)}}]},plugin:[{name:"preview",obj:new RG_Preview},{name:"sizeinfo",obj:new RG_Sizeinfo},{name:"dnd",obj:new RG_DragAndDrop},{name:"thumbnail",obj:new RG_Thumbnail({width:680,height:540,mobileSize:640,url_croppieCSS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.css",url_croppieJS:userData.root+"/vendor/rg-Uploader/vendor/Croppie/croppie.min.js",output:{type:"canvas",quality:.85,format:"jpeg",size:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height}},croppie:{viewport:{width:userData.thumbnailSet.size.width,height:userData.thumbnailSet.size.height,type:"square"}},doneCallback:function(e,t,a){userData.thumbnail_image=e.src,t.queue.$queue.children().removeClass("is-thumbnail"),t.queue.$queue.find(".btn-make-thumbnail").removeClass("on"),t.queue.selectQueueElement(a.id).find(".btn-make-thumbnail").addClass("on");var i=t.plugin.child.thumbnail.croppie.get(),n=t.plugin.child.thumbnail.options;userData.thumbnail.srl=a.srl,userData.thumbnail.points=i.points,userData.thumbnail.zoom=i.zoom,userData.thumbnail.size=n.output.size}})}],uploadParamsFilter:function(){return{ready:1}},uploadDataFilter:function(e){return{state:e[0].state,response:{src:e[0].loc,srl:e[0].srl,name:e[0].name,ready:e[0].ready}}},removeParamsFilter:function(e){return{data:JSON.stringify([{srl:e.srl}])}},removeDataFilter:function(e){},uploadComplete:function(e){userData.addQueue.push(e.srl)},uploadFail:function(e){console.error(e)},init:function(t){userData.addQueue=e.map(t.queue.items.files,function(e){return 1===e.ready?e.srl:null}),userData.articleData.thumbnail&&t.queue.selectQueueElement(userData.articleData.thumbnail.srl).addClass("is-thumbnail").find(".btn-make-thumbnail").addClass("on"),t.$container.find(".select-queue").on("click",function(){return t.queue.selectQueue(),!1})}});var r=e("div.mk-editor"),u=r.find("a[data-control]");u.on("click",function(){var t=e(this).attr("data-control"),i=r.find("[data-target="+t+"]");return e(this).hasClass("active")||(u.removeClass("active"),e(this).addClass("active"),r.find("[data-target]").removeClass("show"),i.addClass("show"),"preview"===t&&userData.form.content.value&&a().done(function(e){i.html(e)})),!1}),e(userData.form).on("submit",function(){if(i())return!1;var e=userData.articleData;userData.thumbnail_image&&(userData.form.thumbnail_image.value=userData.thumbnail_image),e.thumbnail=userData.thumbnail,userData.form.addQueue.value=userData.addQueue.toString(),e=encodeURIComponent(JSON.stringify(e)),userData.form.json.value=e})});